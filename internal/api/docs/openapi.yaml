openapi: 3.1.1
info:
  title: FaaS Application API
  description: |
    API for managing and executing serverless functions. This API allows you to create, manage,
    and execute functions written in Lua, with support for versioning, environment variables,
    and execution logging.
  version: 1.0.0
  contact:
    name: FaaS API Support

servers:
  - url: /
    description: Production server
  - url: http://localhost:3000
    description: Local development server

tags:
  - name: Authentication
    description: Authentication operations
  - name: Functions
    description: Function management operations
  - name: Versions
    description: Function version management
  - name: Executions
    description: Function execution history and logs
  - name: Runtime
    description: Function execution endpoints

security:
  - CookieAuth: []
  - BearerAuth: []

paths:
  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Authenticate with API key
      description: Validates the API key and issues an HttpOnly cookie for subsequent requests.
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            examples:
              validLogin:
                summary: Valid API key
                value:
                  apiKey: example-secret
      responses:
        "200":
          description: Authentication successful
          headers:
            Set-Cookie:
              description: HttpOnly authentication cookie containing the API key.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              examples:
                success:
                  summary: Successful login
                  value:
                    success: true
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              examples:
                invalidBody:
                  summary: Malformed JSON
                  value:
                    success: false
                    error: Invalid request body
        "401":
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              examples:
                invalidAPIKey:
                  summary: Wrong key
                  value:
                    success: false
                    error: Invalid API key

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: Log out current session
      description: Clears the authentication cookie.
      operationId: logout
      security: []
      responses:
        "200":
          description: Logout successful
          headers:
            Set-Cookie:
              description: Expired authentication cookie clearing the session.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
              examples:
                success:
                  summary: Successful logout
                  value:
                    success: true

  /api/functions:
    post:
      tags:
        - Functions
      summary: Create a new function
      description: Creates a new function with the provided code and metadata. The first version is automatically created and activated.
      operationId: createFunction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateFunctionRequest"
            examples:
              simpleFunction:
                summary: Simple HTTP function
                value:
                  name: hello-world
                  description: A simple hello world function
                  code: |
                    function handler(ctx, event)
                      return {
                        statusCode = 200,
                        body = "Hello, World!",
                        headers = {}
                      }
                    end
      responses:
        "200":
          description: Function created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FunctionWithActiveVersion"
        "400":
          description: Validation error (invalid request body or field constraints violated)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                nameEmpty:
                  summary: Empty name
                  value:
                    error: "name: name cannot be empty"
                nameTooLong:
                  summary: Name too long
                  value:
                    error: "name: name cannot be longer than 100 characters"
                codeEmpty:
                  summary: Empty code
                  value:
                    error: "code: code cannot be empty"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      tags:
        - Functions
      summary: List all functions
      description: Returns a paginated list of all functions with their active versions
      operationId: listFunctions
      parameters:
        - name: limit
          in: query
          description: Maximum number of items to return (default 20, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: offset
          in: query
          description: Number of items to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        "200":
          description: List of functions retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListFunctionsResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string
          example: "abc123xyz"

    get:
      tags:
        - Functions
      summary: Get a specific function
      description: Returns detailed information about a function including its active version
      operationId: getFunction
      responses:
        "200":
          description: Function retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FunctionWithActiveVersion"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Function not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      tags:
        - Functions
      summary: Update a function
      description: |
        Updates function metadata and/or code. If code is provided, a new version is created.
        All fields are optional.
      operationId: updateFunction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateFunctionRequest"
            examples:
              updateMetadata:
                summary: Update only metadata
                value:
                  name: new-function-name
                  description: Updated description
              updateCode:
                summary: Update code (creates new version)
                value:
                  code: |
                    function handler(ctx, event)
                      return {statusCode = 200, body = "Updated!", headers = {}}
                    end
              disableFunction:
                summary: Disable function
                value:
                  disabled: true
              enableFunction:
                summary: Enable function
                value:
                  disabled: false
      responses:
        "200":
          description: Function updated successfully
        "400":
          description: Validation error (invalid request body or field constraints violated)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                noFields:
                  summary: No fields provided
                  value:
                    error: "request: at least one field must be provided for update"
                nameEmpty:
                  summary: Empty name
                  value:
                    error: "name: name cannot be empty"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      tags:
        - Functions
      summary: Delete a function
      description: Permanently deletes a function and all its versions
      operationId: deleteFunction
      responses:
        "204":
          description: Function deleted successfully
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Function not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}/versions:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string

    get:
      tags:
        - Versions
      summary: List all versions of a function
      description: Returns a paginated list of all versions of a function in descending order (newest first)
      operationId: listVersions
      parameters:
        - name: limit
          in: query
          description: Maximum number of items to return (default 20, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: offset
          in: query
          description: Number of items to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        "200":
          description: Versions retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListVersionsResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}/versions/{version}:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string
      - name: version
        in: path
        required: true
        description: Version number
        schema:
          type: integer
          minimum: 1
          example: 1

    get:
      tags:
        - Versions
      summary: Get a specific version
      description: Returns detailed information about a specific version of a function
      operationId: getVersion
      responses:
        "200":
          description: Version retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FunctionVersion"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Version not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}/versions/{version}/activate:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string
      - name: version
        in: path
        required: true
        description: Version number to activate
        schema:
          type: integer
          minimum: 1

    post:
      tags:
        - Versions
      summary: Activate a version
      description: Sets the specified version as the active version for the function
      operationId: activateVersion
      responses:
        "200":
          description: Version activated successfully
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}/diff/{v1}/{v2}:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string
      - name: v1
        in: path
        required: true
        description: First version number
        schema:
          type: integer
          minimum: 1
      - name: v2
        in: path
        required: true
        description: Second version number
        schema:
          type: integer
          minimum: 1

    get:
      tags:
        - Versions
      summary: Get diff between two versions
      description: Returns a line-by-line diff between two versions of a function
      operationId: getVersionDiff
      responses:
        "200":
          description: Diff retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VersionDiffResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}/env:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string

    put:
      tags:
        - Functions
      summary: Update environment variables
      description: Updates the environment variables for a function. Does not create a new version.
      operationId: updateEnvVars
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateEnvVarsRequest"
            examples:
              setEnvVars:
                summary: Set environment variables
                value:
                  env_vars:
                    API_KEY: "secret-key-123"
                    DATABASE_URL: "postgresql://localhost/db"
                    DEBUG: "true"
      responses:
        "200":
          description: Environment variables updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FunctionVersion"
        "400":
          description: Validation error (invalid request body or field constraints violated)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidKey:
                  summary: Invalid environment variable key
                  value:
                    error: "env_var_key: environment variable key can only contain letters, numbers, and underscores"
                tooManyVars:
                  summary: Too many environment variables
                  value:
                    error: "env_vars: cannot have more than 100 environment variables"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/functions/{id}/executions:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique identifier of the function
        schema:
          type: string

    get:
      tags:
        - Executions
      summary: List executions of a function
      description: Returns a paginated list of execution history for a function
      operationId: listExecutions
      parameters:
        - name: limit
          in: query
          description: Maximum number of items to return (default 20, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: offset
          in: query
          description: Number of items to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        "200":
          description: Executions retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListExecutionsResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/executions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique execution identifier
        schema:
          type: string
          example: "exec_abc123"

    get:
      tags:
        - Executions
      summary: Get execution details
      description: Returns detailed information about a specific execution
      operationId: getExecution
      responses:
        "200":
          description: Execution retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Execution"
        "404":
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/executions/{id}/logs:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique execution identifier
        schema:
          type: string

    get:
      tags:
        - Executions
      summary: Get execution logs
      description: Returns the execution details along with paginated logs generated during execution
      operationId: getExecutionLogs
      parameters:
        - name: limit
          in: query
          description: Maximum number of log entries to return (default 20, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: offset
          in: query
          description: Number of log entries to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        "200":
          description: Execution logs retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecutionWithLogs"
        "404":
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/executions/{id}/ai-requests:
    parameters:
      - name: id
        in: path
        required: true
        description: Unique execution identifier
        schema:
          type: string

    get:
      tags:
        - Executions
      summary: Get AI requests for an execution
      description: Returns paginated AI API requests made during function execution (OpenAI, Anthropic, etc.)
      operationId: getExecutionAIRequests
      parameters:
        - name: limit
          in: query
          description: Maximum number of AI requests to return (default 20, max 100)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: offset
          in: query
          description: Number of AI requests to skip
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
            example: 0
      responses:
        "200":
          description: AI requests retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListAIRequestsResponse"
        "404":
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /fn/{function_id}:
    parameters:
      - name: function_id
        in: path
        required: true
        description: Unique identifier of the function to execute
        schema:
          type: string
          example: "abc123xyz"

    get:
      tags:
        - Runtime
      summary: Execute function with GET method
      description: |
        Executes the active version of a function with an HTTP GET request.
        Returns custom response headers:
        - X-Function-Id: The function's unique ID
        - X-Function-Version-Id: The version ID that was executed
        - X-Execution-Id: Unique ID for this execution
        - X-Execution-Duration-Ms: Execution time in milliseconds
      operationId: executeFunctionGet
      security: []
      parameters:
        - in: query
          name: query parameters
          description: Any query parameters are passed to the function
          schema:
            type: object
            additionalProperties:
              type: string
      responses:
        "200":
          description: Function executed successfully (status code may vary based on function response)
          headers:
            X-Function-Id:
              description: The function's unique ID
              schema:
                type: string
            X-Function-Version-Id:
              description: The version ID that was executed
              schema:
                type: string
            X-Execution-Id:
              description: Unique ID for this execution
              schema:
                type: string
            X-Execution-Duration-Ms:
              description: Execution time in milliseconds
              schema:
                type: integer
          content:
            "*/*":
              schema:
                type: string
                description: Response body from the function
        "403":
          description: Function is disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                disabled:
                  summary: Function disabled
                  value:
                    error: "Function is disabled"
        "404":
          description: Function not found
        "500":
          description: Function execution failed

    post:
      tags:
        - Runtime
      summary: Execute function with POST method
      description: |
        Executes the active version of a function with an HTTP POST request.
        Returns custom response headers:
        - X-Function-Id: The function's unique ID
        - X-Function-Version-Id: The version ID that was executed
        - X-Execution-Id: Unique ID for this execution
        - X-Execution-Duration-Ms: Execution time in milliseconds
      operationId: executeFunctionPost
      security: []
      parameters:
        - in: query
          name: query parameters
          description: Any query parameters are passed to the function
          schema:
            type: object
            additionalProperties:
              type: string
      requestBody:
        description: Request body passed to the function
        content:
          "*/*":
            schema:
              type: string
      responses:
        "200":
          description: Function executed successfully (status code may vary based on function response)
          headers:
            X-Function-Id:
              schema:
                type: string
            X-Function-Version-Id:
              schema:
                type: string
            X-Execution-Id:
              schema:
                type: string
            X-Execution-Duration-Ms:
              schema:
                type: integer
          content:
            "*/*":
              schema:
                type: string
        "403":
          description: Function is disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Function not found
        "500":
          description: Function execution failed

    put:
      tags:
        - Runtime
      summary: Execute function with PUT method
      description: |
        Executes the active version of a function with an HTTP PUT request.
        Returns custom response headers similar to GET and POST.
      operationId: executeFunctionPut
      security: []
      parameters:
        - in: query
          name: query parameters
          schema:
            type: object
            additionalProperties:
              type: string
      requestBody:
        content:
          "*/*":
            schema:
              type: string
      responses:
        "200":
          description: Function executed successfully
          headers:
            X-Function-Id:
              schema:
                type: string
            X-Function-Version-Id:
              schema:
                type: string
            X-Execution-Id:
              schema:
                type: string
            X-Execution-Duration-Ms:
              schema:
                type: integer
          content:
            "*/*":
              schema:
                type: string
        "403":
          description: Function is disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Function not found
        "500":
          description: Function execution failed

    delete:
      tags:
        - Runtime
      summary: Execute function with DELETE method
      description: |
        Executes the active version of a function with an HTTP DELETE request.
        Returns custom response headers similar to GET and POST.
      operationId: executeFunctionDelete
      security: []
      parameters:
        - in: query
          name: query parameters
          schema:
            type: object
            additionalProperties:
              type: string
      responses:
        "200":
          description: Function executed successfully
          headers:
            X-Function-Id:
              schema:
                type: string
            X-Function-Version-Id:
              schema:
                type: string
            X-Execution-Id:
              schema:
                type: string
            X-Execution-Duration-Ms:
              schema:
                type: integer
          content:
            "*/*":
              schema:
                type: string
        "403":
          description: Function is disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Function not found
        "500":
          description: Function execution failed

components:
  securitySchemes:
    CookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: HttpOnly authentication cookie issued after a successful login.
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: APIKey
      description: Provide the API key as a bearer token in the Authorization header.

  schemas:
    LoginRequest:
      type: object
      required:
        - apiKey
      properties:
        apiKey:
          type: string
          description: API key used to authenticate requests.
          example: example-secret
          minLength: 1

    LoginResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Indicates whether the authentication action succeeded.
          example: true
        error:
          type: string
          description: Error message when the operation fails.
          example: Invalid API key

    Function:
      type: object
      required:
        - id
        - name
        - env_vars
        - disabled
        - created_at
        - updated_at
      properties:
        id:
          type: string
          description: Unique identifier for the function
          example: "abc123xyz"
        name:
          type: string
          description: Human-readable name for the function
          example: "hello-world"
        description:
          type: string
          nullable: true
          description: Optional description of what the function does
          example: "A simple hello world function"
        env_vars:
          type: object
          additionalProperties:
            type: string
          description: Environment variables available to the function
          example:
            API_KEY: "secret-123"
            DEBUG: "true"
        disabled:
          type: boolean
          description: Whether the function is disabled and cannot be executed
          example: false
          default: false
        retention_days:
          type: integer
          nullable: true
          description: Number of days to retain execution logs (default is 7 days)
          enum: [7, 15, 30, 365]
          example: 7
        created_at:
          type: integer
          format: int64
          description: Unix timestamp when the function was created
          example: 1672531200
        updated_at:
          type: integer
          format: int64
          description: Unix timestamp when the function was last updated
          example: 1672617600

    FunctionVersion:
      type: object
      required:
        - id
        - function_id
        - version
        - code
        - created_at
        - is_active
      properties:
        id:
          type: string
          description: Unique identifier for this version
          example: "ver_abc123"
        function_id:
          type: string
          description: ID of the parent function
          example: "abc123xyz"
        version:
          type: integer
          description: Version number (incremental)
          example: 1
          minimum: 1
        code:
          type: string
          description: Lua code for this version
          example: |
            function handler(ctx, event)
              return {statusCode = 200, body = "Hello", headers = {}}
            end
        created_at:
          type: integer
          format: int64
          description: Unix timestamp when this version was created
          example: 1672531200
        created_by:
          type: string
          nullable: true
          description: User who created this version (if applicable)
          example: "user@example.com"
        is_active:
          type: boolean
          description: Whether this is the currently active version
          example: true

    Execution:
      type: object
      required:
        - id
        - function_id
        - function_version_id
        - execution_id
        - status
        - created_at
      properties:
        id:
          type: string
          description: Internal database ID
          example: "1"
        function_id:
          type: string
          description: ID of the function that was executed
          example: "abc123xyz"
        function_version_id:
          type: string
          description: ID of the version that was executed
          example: "ver_abc123"
        execution_id:
          type: string
          description: Unique execution identifier
          example: "exec_xyz789"
        status:
          type: string
          enum:
            - pending
            - success
            - error
          description: Status of the execution
          example: "success"
        duration_ms:
          type: integer
          format: int64
          nullable: true
          description: Execution duration in milliseconds
          example: 125
        error_message:
          type: string
          nullable: true
          description: Error message if execution failed
          example: "Runtime error: attempt to call nil value"
        created_at:
          type: integer
          format: int64
          description: Unix timestamp when execution started
          example: 1672531200

    ExecutionWithLogCount:
      allOf:
        - $ref: "#/components/schemas/Execution"
        - type: object
          required:
            - log_count
          properties:
            log_count:
              type: integer
              format: int64
              description: Number of log entries for this execution
              example: 5

    LogEntry:
      type: object
      required:
        - id
        - execution_id
        - level
        - message
        - created_at
      properties:
        id:
          type: string
          description: Unique identifier for the log entry
          example: "log_123"
        execution_id:
          type: string
          description: ID of the execution this log belongs to
          example: "exec_xyz789"
        level:
          type: string
          description: Log level
          enum:
            - debug
            - info
            - warn
            - error
          example: "info"
        message:
          type: string
          description: Log message content
          example: "Processing request for user 123"
        created_at:
          type: integer
          format: int64
          description: Unix timestamp when log was created
          example: 1672531200

    DiffLine:
      type: object
      required:
        - line_type
        - content
      properties:
        line_type:
          type: string
          enum:
            - unchanged
            - added
            - removed
          description: Type of change for this line
          example: "unchanged"
        old_line:
          type: integer
          nullable: true
          description: Line number in old version (null for added lines)
          example: 5
        new_line:
          type: integer
          nullable: true
          description: Line number in new version (null for removed lines)
          example: 5
        content:
          type: string
          description: Content of the line
          example: "  return {statusCode = 200}"

    CreateFunctionRequest:
      type: object
      required:
        - name
        - code
      properties:
        name:
          type: string
          description: Name for the function (must be non-empty after trimming whitespace)
          example: "hello-world"
          minLength: 1
          maxLength: 100
        description:
          type: string
          nullable: true
          description: Optional description
          example: "A simple hello world function"
          maxLength: 500
        code:
          type: string
          description: Lua code for the function (must be non-empty after trimming whitespace)
          example: |
            function handler(ctx, event)
              return {statusCode = 200, body = "Hello", headers = {}}
            end
          minLength: 1
          maxLength: 1048576

    UpdateFunctionRequest:
      type: object
      description: At least one field must be provided
      properties:
        name:
          type: string
          nullable: true
          description: New name for the function (must be non-empty after trimming whitespace)
          example: "updated-name"
          minLength: 1
          maxLength: 100
        description:
          type: string
          nullable: true
          description: New description
          example: "Updated description"
          maxLength: 500
        code:
          type: string
          nullable: true
          description: New code (creates a new version, must be non-empty after trimming whitespace)
          example: |
            function handler(ctx, event)
              return {statusCode = 200, body = "Updated!", headers = {}}
            end
          minLength: 1
          maxLength: 1048576
        disabled:
          type: boolean
          nullable: true
          description: Set to true to disable the function (preventing execution), false to enable it
          example: false
        retention_days:
          type: integer
          nullable: true
          description: Number of days to retain execution logs
          enum: [7, 15, 30, 365]
          example: 30

    UpdateEnvVarsRequest:
      type: object
      required:
        - env_vars
      properties:
        env_vars:
          type: object
          additionalProperties:
            type: string
            maxLength: 10000
          description: |
            Environment variables to set (max 100 variables).
            Keys must contain only letters, numbers, and underscores (max 100 chars).
            Values can be up to 10,000 characters.
          example:
            API_KEY: "new-secret"
            DATABASE_URL: "postgresql://localhost/db"
          maxProperties: 100

    FunctionWithActiveVersion:
      allOf:
        - $ref: "#/components/schemas/Function"
        - type: object
          required:
            - active_version
          properties:
            active_version:
              $ref: "#/components/schemas/FunctionVersion"

    ListFunctionsResponse:
      type: object
      required:
        - functions
        - pagination
      properties:
        functions:
          type: array
          items:
            $ref: "#/components/schemas/FunctionWithActiveVersion"
        pagination:
          $ref: "#/components/schemas/PaginationInfo"

    ListVersionsResponse:
      type: object
      required:
        - versions
        - pagination
      properties:
        versions:
          type: array
          items:
            $ref: "#/components/schemas/FunctionVersion"
        pagination:
          $ref: "#/components/schemas/PaginationInfo"

    ListExecutionsResponse:
      type: object
      required:
        - executions
        - pagination
      properties:
        executions:
          type: array
          items:
            $ref: "#/components/schemas/ExecutionWithLogCount"
        pagination:
          $ref: "#/components/schemas/PaginationInfo"

    ExecutionWithLogs:
      allOf:
        - $ref: "#/components/schemas/Execution"
        - type: object
          required:
            - logs
            - pagination
          properties:
            logs:
              type: array
              items:
                $ref: "#/components/schemas/LogEntry"
            pagination:
              $ref: "#/components/schemas/PaginationInfo"

    AIRequest:
      type: object
      required:
        - id
        - execution_id
        - provider
        - model
        - endpoint
        - request_json
        - status
        - duration_ms
        - created_at
      properties:
        id:
          type: string
          description: Unique identifier for the AI request
          example: "aireq_abc123"
        execution_id:
          type: string
          description: ID of the execution this request belongs to
          example: "exec_xyz789"
        provider:
          type: string
          description: AI provider name
          enum:
            - openai
            - anthropic
          example: "openai"
        model:
          type: string
          description: Model name used for the request
          example: "gpt-4"
        endpoint:
          type: string
          description: API endpoint called
          example: "/v1/chat/completions"
        request_json:
          type: string
          description: JSON-encoded request payload (sensitive data masked)
          example: '{"model":"gpt-4","messages":[...]}'
        response_json:
          type: string
          nullable: true
          description: JSON-encoded response payload (sensitive data masked)
          example: '{"id":"chatcmpl-...","choices":[...]}'
        status:
          type: string
          enum:
            - success
            - error
          description: Status of the AI request
          example: "success"
        error_message:
          type: string
          nullable: true
          description: Error message if the request failed
          example: "Rate limit exceeded"
        input_tokens:
          type: integer
          nullable: true
          description: Number of input tokens used
          example: 150
        output_tokens:
          type: integer
          nullable: true
          description: Number of output tokens generated
          example: 75
        duration_ms:
          type: integer
          format: int64
          description: Request duration in milliseconds
          example: 1250
        created_at:
          type: integer
          format: int64
          description: Unix timestamp when the request was made
          example: 1672531200

    ListAIRequestsResponse:
      type: object
      required:
        - ai_requests
        - pagination
      properties:
        ai_requests:
          type: array
          items:
            $ref: "#/components/schemas/AIRequest"
        pagination:
          $ref: "#/components/schemas/PaginationInfo"

    VersionDiffResponse:
      type: object
      required:
        - old_version
        - new_version
        - diff
      properties:
        old_version:
          type: integer
          description: First version number
          example: 1
        new_version:
          type: integer
          description: Second version number
          example: 2
        diff:
          type: array
          items:
            $ref: "#/components/schemas/DiffLine"
          description: Line-by-line diff

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Function not found"

    PaginationInfo:
      type: object
      required:
        - total
        - limit
        - offset
      properties:
        total:
          type: integer
          format: int64
          description: Total number of items available
          example: 42
        limit:
          type: integer
          description: Number of items per page
          example: 20
        offset:
          type: integer
          description: Number of items skipped
          example: 0
